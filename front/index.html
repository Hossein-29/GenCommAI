<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحلیل محصول</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl;
            background-color: #f2f3f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 100%;
            max-width: 800px;
        }
        .btn-primary {
            background-color: #d73948;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #f04151;
        }
        .btn-secondary {
            background-color: #3468cc;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #3a75e6;
        }
        .chart-container {
            position: relative;
            height: 250px; /* Fixed height for charts */
            width: 100%;
            margin-bottom: 20px;
        }
        .center-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        /* Hide scrollbar for input type file */
        input[type="file"]::-webkit-file-upload-button {
            visibility: hidden;
        }
        input[type="file"]::before {
            content: 'انتخاب تصویر';
            display: inline-block;
            background: #e0e0e0;
            border: 1px solid #999;
            border-radius: 3px;
            padding: 8px 12px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 10pt;
            color: #333;
        }
        input[type="file"]:hover::before {
            border-color: black;
        }
        input[type="file"]:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f0f0f0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="inputPage" class="flex flex-col items-center justify-center space-y-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">تحلیلگر محصول / موضوع</h1>
            
            <div class="w-full">
                <label for="productName" class="block text-gray-700 text-lg font-medium mb-2">نام محصول یا موضوع:</label>
                <input type="text" id="productName" placeholder="مثال: هدفون سونی WH-1000XM5" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="w-full flex items-center justify-center space-x-4 space-x-reverse">
                <span class="text-gray-600">یا</span>
                <label for="productImage" class="block text-gray-700 text-lg font-medium">تصویر محصول:</label>
                <input type="file" id="productImage" accept="image/*" class="w-full p-3 border border-gray-300 rounded-md">
            </div>
            
            <button id="analyzeButton" class="btn-primary w-full max-w-xs">تحلیل کن</button>
        </div>

        <div id="displayPage" class="hidden flex flex-col space-y-6">
            <h1 id="displayTitle" class="text-3xl font-bold text-gray-800 text-center"></h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col items-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">رضایت کاربران</h2>
                    <div class="chart-container">
                        <canvas id="likesDislikesChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-600">نمودار لایک و دیسلایک</p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col items-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">درصد رضایت فروشگاه‌ها</h2>
                    <div class="chart-container">
                        <canvas id="satisfactionChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-600">نمودار میله‌ای رضایت</p>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">خلاصه نظرات</h2>
                <p id="commentsText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <button id="backButton" class="btn-secondary w-full max-w-xs self-center">بازگشت</button>
        </div>
    </div>

    <script>
        // Mock data based on the hypothetical JSON structure
        const mockProductData = {
            "هدفون سونی WH-1000XM5": {
                "Likes_Dislikes": {
                    "likes": 85,
                    "dislikes": 15
                },
                "Satisfaction_percentage": [
                    {"store": "دیجیپل", "satisfaction": 90},
                    {"store": "هایتل", "satisfaction": 75},
                    {"store": "لیون کامپیوتر", "satisfaction": 88},
                    {"store": "ایران رهجو", "satisfaction": 95}
                ],
                "Text": "این هدفون بی‌سیم سونی مدل WH-1000XM5، از نظر کاربران یکی از بهترین انتخاب‌ها برای تجربه صوتی بی‌نظیر است. بسیاری از خریداران از کیفیت حذف نویز فعال آن شگفت‌زده شده‌اند و آن را برای محیط‌های شلوغ مانند پرواز و مترو بسیار مناسب می‌دانند. کیفیت صدای این هدفون نیز بسیار مورد تحسین قرار گرفته است، با باس عمیق و جزئیات واضح که تجربه شنیداری لذت‌بخشی را فراهم می‌کند. راحتی استفاده طولانی‌مدت از این هدفون، نکته مثبت دیگری است که در نظرات کاربران به چشم می‌خورد. طراحی سبک و ارگونومیک آن باعث می‌شود که حتی پس از ساعت‌ها استفاده، احساس خستگی نکنید. با این حال، برخی کاربران به قیمت نسبتاً بالای آن اشاره کرده‌اند که می‌تواند یک مانع برای برخی خریداران باشد. در مجموع، این هدفون برای کسانی که به دنبال کیفیت صدای عالی، حذف نویز بی‌نظیر و راحتی فوق‌العاده هستند، توصیه می‌شود."
            },
            "موضوع عمومی": {
                "Likes_Dislikes": {
                    "likes": 70,
                    "dislikes": 30
                },
                "Satisfaction_percentage": [
                    {"store": "فروشگاه الف", "satisfaction": 60},
                    {"store": "فروشگاه ب", "satisfaction": 80},
                    {"store": "فروشگاه ج", "satisfaction": 70}
                ],
                "Text": "این یک خلاصه عمومی از نظرات است. کاربران در مورد این موضوع نظرات متفاوتی داشتند. برخی جنبه‌های مثبت را برجسته کردند، در حالی که برخی دیگر به نقاط ضعف اشاره کردند. در مجموع، بازخوردها نشان‌دهنده طیف وسیعی از تجربیات است."
            }
        };

        // Get elements
        const inputPage = document.getElementById('inputPage');
        const displayPage = document.getElementById('displayPage');
        const productNameInput = document.getElementById('productName');
        const productImageInput = document.getElementById('productImage');
        const analyzeButton = document.getElementById('analyzeButton');
        const backButton = document.getElementById('backButton');
        const displayTitle = document.getElementById('displayTitle');
        const commentsText = document.getElementById('commentsText');

        let likesDislikesChartInstance = null;
        let satisfactionChartInstance = null;

        // Plugin to display text in the center of the doughnut chart
        const centerTextPlugin = {
            id: 'centerText',
            beforeDraw: function(chart) {
                if (chart.config.options.elements && chart.config.options.elements.center) { // Added check for elements
                    const ctx = chart.ctx;
                    const centerConfig = chart.config.options.elements.center;
                    const fontStyle = centerConfig.fontStyle || 'Inter';
                    const txt = centerConfig.text;
                    const color = centerConfig.color || '#000';
                    
                    ctx.font = "bold " + centerConfig.fontSize + "px " + fontStyle;
                    ctx.fillStyle = color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
                    const centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);

                    ctx.fillText(txt, centerX, centerY);
                }
            }
        };

        // Register the plugin globally
        Chart.register(centerTextPlugin);

        // Function to render charts and text
        function renderAnalysis(data, title) {
            displayTitle.textContent = title;
            commentsText.textContent = data.Text;

            // Destroy existing chart instances if they exist
            if (likesDislikesChartInstance) {
                likesDislikesChartInstance.destroy();
            }
            if (satisfactionChartInstance) {
                satisfactionChartInstance.destroy();
            }

            // Pie Chart for Likes/Dislikes
            const likesDislikesCtx = document.getElementById('likesDislikesChart').getContext('2d');
            const totalVotes = data.Likes_Dislikes.likes + data.Likes_Dislikes.dislikes;
            const satisfactionPercentage = totalVotes > 0 ? ((data.Likes_Dislikes.likes / totalVotes) * 100).toFixed(0) : 0;

            likesDislikesChartInstance = new Chart(likesDislikesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['لایک', 'دیسلایک'],
                    datasets: [{
                        data: [data.Likes_Dislikes.likes, data.Likes_Dislikes.dislikes],
                        backgroundColor: [
                            '#d73948', // Red for likes
                            '#ffffff'  // White for dislikes
                        ],
                        borderColor: [
                            '#d73948',
                            '#cccccc'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // Make it a doughnut chart
                    elements: {
                        center: {
                            text: satisfactionPercentage + '%',
                            color: '#333',
                            fontStyle: 'Inter',
                            fontSize: 24,
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) { label += context.parsed + '%'; }
                                    return label;
                                }
                            },
                            titleFont: { family: 'Inter' },
                            bodyFont: { family: 'Inter' }
                        }
                    }
                }
            });
            likesDislikesChartInstance.update(); // Force update after creation

            // Bar Chart for Satisfaction Percentage
            const satisfactionCtx = document.getElementById('satisfactionChart').getContext('2d');
            satisfactionChartInstance = new Chart(satisfactionCtx, {
                type: 'bar',
                data: {
                    labels: data.Satisfaction_percentage.map(item => item.store),
                    datasets: [{
                        label: 'درصد رضایت',
                        data: data.Satisfaction_percentage.map(item => item.satisfaction),
                        backgroundColor: [
                            'rgba(52, 104, 204, 0.8)',
                            'rgba(215, 57, 72, 0.8)',
                            'rgba(11, 81, 36, 0.8)',
                            'rgba(255, 202, 50, 0.8)'
                        ],
                        borderColor: [
                            'rgba(52, 104, 204, 1)',
                            'rgba(215, 57, 72, 1)',
                            'rgba(11, 81, 36, 1)',
                            'rgba(255, 202, 50, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) { return value + '%'; },
                                font: { family: 'Inter' }
                            },
                            grid: { color: '#e6e6e6' }
                        },
                        x: {
                            ticks: { font: { family: 'Inter' } },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += context.parsed.y + '%'; }
                                    return label;
                                }
                            },
                            titleFont: { family: 'Inter' },
                            bodyFont: { family: 'Inter' }
                        }
                    }
                }
            });
            satisfactionChartInstance.update(); // Force update after creation

            inputPage.classList.add('hidden');
            displayPage.classList.remove('hidden');
        }

        // Event Listeners
        analyzeButton.addEventListener('click', () => {
            const productName = productNameInput.value.trim();
            const productImage = productImageInput.files[0]; // Get the selected file

            let dataToRender = null;
            let title = "تحلیل محصول/موضوع";

            if (productName === "هدفون سونی WH-1000XM5") {
                dataToRender = mockProductData["هدفون سونی WH-1000XM5"];
                title = "تحلیل: هدفون سونی WH-1000XM5";
            } else if (productName !== "") {
                // For any other text input, use generic data
                dataToRender = mockProductData["موضوع عمومی"];
                title = `تحلیل: ${productName}`;
            } else if (productImage) {
                // For image input, use generic data (in a real app, you'd send image to backend)
                dataToRender = mockProductData["موضوع عمومی"];
                title = "تحلیل تصویر محصول";
            } else {
                alert("لطفاً نام محصول یا موضوع را وارد کنید یا یک تصویر انتخاب نمایید.");
                return;
            }

            renderAnalysis(dataToRender, title);
        });

        backButton.addEventListener('click', () => {
            displayPage.classList.add('hidden');
            inputPage.classList.remove('hidden');
            // Clear inputs for next search
            productNameInput.value = '';
            productImageInput.value = ''; // Clear file input
        });

        // Initial state: show input page
        inputPage.classList.remove('hidden');
        displayPage.classList.add('hidden');
    </script>
</body>
</html>
