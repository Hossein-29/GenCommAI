<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحلیل محصول</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl;
            background-color: #f2f3f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 100%;
            max-width: 800px;
        }
        .btn-primary {
            background-color: #d73948;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #f04151;
        }
        .btn-secondary {
            background-color: #3468cc;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #3a75e6;
        }
        .chart-container {
            position: relative;
            height: 250px; /* Fixed height for charts */
            width: 100%;
            margin-bottom: 20px;
        }
        .center-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        /* Styles for file input button (not used in this version, but kept for reference) */
        input[type="file"]::-webkit-file-upload-button {
            visibility: hidden;
        }
        input[type="file"]::before {
            content: 'انتخاب تصویر';
            display: inline-block;
            background: #e0e0e0;
            border: 1px solid #999;
            border-radius: 3px;
            padding: 8px 12px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 10pt;
            color: #333;
        }
        input[type="file"]:hover::before {
            border-color: black;
        }
        input[type="file"]:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f0f0f0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="inputPage" class="flex flex-col items-center justify-center space-y-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">تحلیلگر محصول / موضوع</h1>
            
            <div class="w-full">
                <label for="productName" class="block text-gray-700 text-lg font-medium mb-2">نام محصول یا موضوع:</label>
                <input type="text" id="productName" placeholder="مثال: هدفون سونی WH-1000XM6" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <button id="analyzeButton" class="btn-primary w-full max-w-xs">تحلیل کن</button>
        </div>

        <div id="displayPage" class="hidden flex flex-col space-y-6">
            <h1 id="displayTitle" class="text-3xl font-bold text-gray-800 text-center"></h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col items-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">رضایت کاربران</h2>
                    <div class="chart-container">
                        <canvas id="likesDislikesChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-600">نمودار رضایت کلی</p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col items-center justify-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">امتیا کلی</h2>
                    <p id="overallScoreText" class="text-2xl text-gray-900"></p>
                </div>

                <!-- Bar chart is commented out as it's not in the new JSON format.
                     If you need it back, uncomment this section and its JS logic.
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col items-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">درصد رضایت فروشگاه‌ها</h2>
                    <div class="chart-container">
                        <canvas id="satisfactionChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-600">نمودار میله‌ای رضایت</p>
                </div>
                -->
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">بررسی و خلاصه</h2>
                <p id="reviewSummaryText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">نکات و ارزیابی</h2>
                <p id="evaluationText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <button id="backButton" class="btn-secondary w-full max-w-xs self-center">بازگشت</button>
        </div>
    </div>

    <script>
        // آدرس بک‌اند شما
        const API_URL = 'http://localhost:8000/agent/chat2'; // Endpoint جدید

        // Get elements
        const inputPage = document.getElementById('inputPage');
        const displayPage = document.getElementById('displayPage');
        const productNameInput = document.getElementById('productName');
        const analyzeButton = document.getElementById('analyzeButton');
        const backButton = document.getElementById('backButton');
        const displayTitle = document.getElementById('displayTitle');
        
        // عناصر نمایش پاسخ بک‌اند
        const reviewSummaryText = document.getElementById('reviewSummaryText'); // جدید برای Review
        const evaluationText = document.getElementById('evaluationText'); // برای Tips
        const overallScoreText = document.getElementById('overallScoreText'); // جدید برای Overall score

        let likesDislikesChartInstance = null; 
        // let satisfactionChartInstance = null; // Bar chart is still commented out

        // Plugin to display text in the center of the doughnut chart
        const centerTextPlugin = {
            id: 'centerText',
            beforeDraw: function(chart) {
                if (chart.config.options.elements && chart.config.options.elements.center) {
                    const ctx = chart.ctx;
                    const centerConfig = chart.config.options.elements.center;
                    const fontStyle = centerConfig.fontStyle || 'Inter';
                    const txt = centerConfig.text;
                    const color = centerConfig.color || '#000';
                    
                    ctx.font = "bold " + centerConfig.fontSize + "px " + fontStyle;
                    ctx.fillStyle = color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
                    const centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);

                    ctx.fillText(txt, centerX, centerY);
                }
            }
        };

        // Register the plugin globally
        Chart.register(centerTextPlugin);

        // Function to render analysis data
        function renderAnalysis(data, title) {
            // Log the received data to console for debugging
            console.log("Received data from backend:", data);

            displayTitle.textContent = title;
            
            // Populate new text fields based on the new JSON structure
            reviewSummaryText.textContent = data.Review || 'بررسی و خلاصه موجود نیست.';
            evaluationText.textContent = data.Tips || 'نکات و ارزیابی موجود نیست.';
            // Ensure correct access for 'Overall score' which has a space
            overallScoreText.textContent = data['Overall score'] || 'نامشخص'; 

            // Destroy existing chart instance if it exists
            if (likesDislikesChartInstance) {
                likesDislikesChartInstance.destroy();
            }
            // if (satisfactionChartInstance) { satisfactionChartInstance.destroy(); } // Bar chart instance

            // Pie Chart for User Satisfaction
            const likesDislikesCtx = document.getElementById('likesDislikesChart').getContext('2d');
            // Extract user satisfaction from Scores object, convert to number
            // Ensure 'user satisfaction' is accessed correctly and parsed to a float, then multiplied by 10
            const userSatisfaction = data.Scores && data.Scores['user satisfaction'] ? parseFloat(data.Scores['user satisfaction']) : 64; 
            const dissatisfactionRate = 100 - userSatisfaction;

            likesDislikesChartInstance = new Chart(likesDislikesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['رضایت کاربران', 'عدم رضایت'],
                    datasets: [{
                        data: [userSatisfaction, dissatisfactionRate],
                        backgroundColor: [
                            '#d73948', // Red for satisfaction
                            '#ffffff'  // White for dissatisfaction
                        ],
                        borderColor: [
                            '#d73948',
                            '#cccccc'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', // Make it a doughnut chart
                    elements: {
                        center: {
                            text: userSatisfaction + '%', // Display user satisfaction percentage in center
                            color: '#333',
                            fontStyle: 'Inter',
                            fontSize: 24,
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) { label += context.parsed + '%'; }
                                    return label;
                                }
                            },
                            titleFont: { family: 'Inter' },
                            bodyFont: { family: 'Inter' }
                        }
                    }
                }
            });
            likesDislikesChartInstance.update(); // Force update after creation

            inputPage.classList.add('hidden');
            displayPage.classList.remove('hidden');
        }

        // تابع برای واکشی داده از بک‌اند
        async function fetchAnalysisDataFromBackend(productName) {
            let apiUrl = API_URL;
            let options = {};
            let titleForDisplay = "";

            options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: productName })
            };
            titleForDisplay = `تحلیل: ${productName}`;
            
            try {
                const response = await fetch(apiUrl, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'خطای نامشخص از سرور' }));
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || response.statusText}`);
                }
                const data = await response.json();
                
                // در اینجا، داده‌های دریافتی از بک‌اند را مستقیماً استفاده می‌کنیم.
                // اگر بک‌اند شما 'user satisfaction' را به صورت رشته برمی‌گرداند،
                // مطمئن شوید که قبل از استفاده در نمودار آن را به عدد تبدیل کنید.
                // در این مثال، فرض شده که 'user satisfaction' در 'Scores' به صورت رشته است
                // و ما آن را در renderAnalysis به عدد تبدیل می‌کنیم.

                return {data: data, title: titleForDisplay};
            } catch (error) {
                console.error('Error fetching analysis data:', error);
                alert(`خطا در دریافت اطلاعات تحلیل از سرور: ${error.message}. لطفاً مطمئن شوید بک‌اند در حال اجراست و به درستی پاسخ می‌دهد.`);
                return {data: null, title: ""};
            }
        }

        // Event Listener برای دکمه تحلیل کن
        analyzeButton.addEventListener('click', async () => {
            const productName = productNameInput.value.trim();

            if (!productName) {
                alert("لطفاً نام محصول یا موضوع را وارد کنید.");
                return;
            }

            // نمایش لودینگ و غیرفعال کردن دکمه
            analyzeButton.textContent = 'در حال تحلیل...';
            analyzeButton.disabled = true;

            // فراخوانی تابع برای واکشی داده از بک‌اند
            const {data: dataToRender, title: displayTitleText} = await fetchAnalysisDataFromBackend(productName);

            // پنهان کردن لودینگ و فعال کردن دکمه
            analyzeButton.textContent = 'تحلیل کن';
            analyzeButton.disabled = false;

            if (dataToRender) {
                renderAnalysis(dataToRender, displayTitleText);
            }
        });

        backButton.addEventListener('click', () => {
            displayPage.classList.add('hidden');
            inputPage.classList.remove('hidden');
            productNameInput.value = '';
        });

        // Initial state: show input page
        inputPage.classList.remove('hidden');
        displayPage.classList.add('hidden');
    </script>
</body>
</html>
