<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحلیل محصول</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl;
            background-color: #f2f3f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 100%;
            max-width: 800px;
        }
        .btn-primary {
            background-color: #d73948;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #f04151;
        }
        .btn-secondary {
            background-color: #3468cc;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #3a75e6;
        }
        /* Styles for chart containers are kept but might not be used if charts are removed */
        .chart-container {
            position: relative;
            height: 250px; 
            width: 100%;
            margin-bottom: 20px;
        }
        /* Styles for file input button (not used in this version, but kept for reference) */
        input[type="file"]::-webkit-file-upload-button {
            visibility: hidden;
        }
        input[type="file"]::before {
            content: 'انتخاب تصویر';
            display: inline-block;
            background: #e0e0e0;
            border: 1px solid #999;
            border-radius: 3px;
            padding: 8px 12px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 10pt;
            color: #333;
        }
        input[type="file"]:hover::before {
            border-color: black;
        }
        input[type="file"]:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f0f0f0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="inputPage" class="flex flex-col items-center justify-center space-y-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">تحلیلگر محصول / موضوع</h1>
            
            <div class="w-full">
                <label for="productName" class="block text-gray-700 text-lg font-medium mb-2">نام محصول یا موضوع:</label>
                <input type="text" id="productName" placeholder="مثال: هدفون سونی WH-1000XM5" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- <div class="w-full flex items-center justify-center space-x-4 space-x-reverse">
                <span class="text-gray-600">یا</span>
                <label for="productImage" class="block text-gray-700 text-lg font-medium">تصویر محصول:</label>
                <input type="file" id="productImage" accept="image/*" class="w-full p-3 border border-gray-300 rounded-md">
            </div> -->
            
            <button id="analyzeButton" class="btn-primary w-full max-w-xs">تحلیل کن</button>
        </div>

        <div id="displayPage" class="hidden flex flex-col space-y-6">
            <h1 id="displayTitle" class="text-3xl font-bold text-gray-800 text-center"></h1>
            
            <!-- <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col items-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">رضایت کاربران</h2>
                    <div class="chart-container">
                        <canvas id="likesDislikesChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-600">نمودار لایک و دیسلایک</p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col items-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">درصد رضایت فروشگاه‌ها</h2>
                    <div class="chart-container">
                        <canvas id="satisfactionChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-600">نمودار میله‌ای رضایت</p>
                </div>
            </div> -->

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">خلاصه</h2>
                <p id="summaryText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">بررسی</h2>
                <p id="reviewText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ارزیابی</h2>
                <p id="evaluationText" class="text-gray-700 leading-relaxed"></p>
            </div>

            <button id="backButton" class="btn-secondary w-full max-w-xs self-center">بازگشت</button>
        </div>
    </div>

    <script>
        // آدرس بک‌اند Flask شما
        const API_URL = 'http://localhost:8000/agent/chat';

        // Get elements
        const inputPage = document.getElementById('inputPage');
        const displayPage = document.getElementById('displayPage');
        const productNameInput = document.getElementById('productName');
        const analyzeButton = document.getElementById('analyzeButton');
        const backButton = document.getElementById('backButton');
        const displayTitle = document.getElementById('displayTitle');
        
        // عناصر جدید برای نمایش پاسخ بک‌اند
        const summaryText = document.getElementById('summaryText');
        const reviewText = document.getElementById('reviewText');
        const evaluationText = document.getElementById('evaluationText');

        // Function to render analysis data
        function renderAnalysis(data, title) {
            displayTitle.textContent = title;
            
            // Populate new text fields
            summaryText.textContent = data.summary || 'خلاصه موجود نیست.';
            reviewText.textContent = data.review || 'بررسی موجود نیست.';
            evaluationText.textContent = data.evaluation || 'ارزیابی موجود نیست.';

            inputPage.classList.add('hidden');
            displayPage.classList.remove('hidden');
        }

        // تابع برای واکشی داده از بک‌اند
        async function fetchAnalysisDataFromBackend(productName) {
            let apiUrl = API_URL;
            let options = {};
            let titleForDisplay = "";

            // همیشه درخواست POST با فرمت JSON ارسال می‌شود
            options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: productName }) // فرمت جدید درخواست
            };
            titleForDisplay = `تحلیل: ${productName}`;
            
            try {
                const response = await fetch(apiUrl, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'خطای نامشخص از سرور' }));
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || response.statusText}`);
                }
                const data = await response.json();
                return {data: data, title: titleForDisplay};
            } catch (error) {
                console.error('Error fetching analysis data:', error);
                alert(`خطا در دریافت اطلاعات تحلیل از سرور: ${error.message}. لطفاً مطمئن شوید بک‌اند در حال اجراست و به درستی پاسخ می‌دهد.`);
                return {data: null, title: ""};
            }
        }

        // Event Listener برای دکمه تحلیل کن
        analyzeButton.addEventListener('click', async () => {
            const productName = productNameInput.value.trim();

            if (!productName) {
                alert("لطفاً نام محصول یا موضوع را وارد کنید.");
                return;
            }

            // نمایش لودینگ و غیرفعال کردن دکمه
            analyzeButton.textContent = 'در حال تحلیل...';
            analyzeButton.disabled = true;

            // فراخوانی تابع برای واکشی داده از بک‌اند
            const {data: dataToRender, title: displayTitleText} = await fetchAnalysisDataFromBackend(productName);

            // پنهان کردن لودینگ و فعال کردن دکمه
            analyzeButton.textContent = 'تحلیل کن';
            analyzeButton.disabled = false;

            if (dataToRender) {
                renderAnalysis(dataToRender, displayTitleText);
            }
        });

        backButton.addEventListener('click', () => {
            displayPage.classList.add('hidden');
            inputPage.classList.remove('hidden');
            productNameInput.value = '';
        });

        // Initial state: show input page
        inputPage.classList.remove('hidden');
        displayPage.classList.add('hidden');
    </script>
</body>
</html>
